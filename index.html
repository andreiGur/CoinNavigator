<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinNavigator | Professional Crypto Arbitrage Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #0f172a;
            --accent: #10b981;
            --bg: #0b0f1a;
            --card-bg: #161b2a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #2d334a;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
        }
        html { scroll-behavior: smooth; }

        /* Animated Background */
        .bg-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        .bg-grid {
            position: fixed;
            inset: 0;
            background-image:
              linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
              linear-gradient(to bottom, rgba(255,255,255,0.04) 1px, transparent 1px);
            background-size: 80px 80px;
            opacity: 0.15;
            z-index: -2;
            pointer-events: none;
            mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 65%);
        }

        /* Subtle entrance animation */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Navigation */
        nav {
            background: rgba(11, 15, 26, 0.8);
            backdrop-filter: blur(12px);
            padding: 1.25rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: white; text-decoration: none; display: flex; align-items: center; gap: 12px; }
        .logo i { color: var(--primary); }
        
        .nav-links { display: flex; gap: 2.5rem; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--text-muted); font-weight: 500; font-size: 0.9rem; transition: all 0.2s; }
        .nav-links a:hover { color: var(--primary-light); }

        .nav-cta { display: flex; gap: 0.75rem; align-items: center; }

        .btn {
            border: 1px solid transparent;
            border-radius: 12px;
            font-weight: 700;
            padding: 0.75rem 1.1rem;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s, background 0.2s, border-color 0.2s, color 0.2s;
            will-change: transform;
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-ghost { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); color: var(--text-main); }
        .btn-ghost:hover { border-color: rgba(129, 140, 248, 0.7); }

        /* Hero Section */
        .hero {
            padding: 6rem 2rem;
            text-align: center;
            position: relative;
        }
        .hero h1 { 
            font-size: 4rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 1.5rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hero p { color: var(--text-muted); font-size: 1.25rem; max-width: 700px; margin: 0 auto 2.5rem; }

        .hero-cta {
            display: flex;
            justify-content: center;
            gap: 0.9rem;
            flex-wrap: wrap;
            animation: fadeUp 700ms ease-out 120ms both;
        }

        .trust-row {
            margin-top: 1.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            opacity: 0.9;
        }
        .pill {
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }
        .pill i { color: var(--accent); }

        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; max-width: 1200px; margin: -3rem auto 3rem; padding: 0 2rem;
        }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--border);
            padding: 1.5rem; border-radius: 16px; text-align: center;
            animation: fadeUp 650ms ease-out both;
            transition: transform 0.2s, border-color 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); border-color: rgba(129, 140, 248, 0.55); }
        .stat-card h4 { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }

        /* Main Dashboard */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        
        .dashboard-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: fadeUp 650ms ease-out 50ms both;
        }

        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--accent); font-weight: 600; }
        .dot { height: 8px; width: 8px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { text-align: left; padding: 1.25rem; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 1.5rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .symbol-box { display: flex; align-items: center; gap: 12px; }
        .symbol-box .name { font-weight: 700; font-size: 1.1rem; }
        
        .price-val { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
        .spread-val { 
            background: rgba(16, 185, 129, 0.1); color: var(--accent); 
            padding: 0.5rem 1rem; border-radius: 12px; font-weight: 700; 
        }

        .btn-trade {
            background: var(--primary); color: white; text-decoration: none;
            padding: 0.6rem 1.2rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600;
            transition: all 0.2s; display: inline-block;
        }
        .btn-trade:hover { background: var(--primary-light); transform: translateY(-2px); }

        .btn-mini {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-main);
            padding: 0.55rem 0.9rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, border-color 0.2s, background 0.2s;
            white-space: nowrap;
        }
        .btn-mini:hover { transform: translateY(-2px); border-color: rgba(129, 140, 248, 0.7); }
        .btn-mini-primary { background: rgba(99,102,241,0.18); border-color: rgba(99,102,241,0.35); }

        .row-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .details-row td { padding-top: 0; }
        .details {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 1rem;
            margin: 0.75rem 0 1.25rem;
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
        }
        .details-item {
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.02);
            border-radius: 14px;
            padding: 0.75rem 0.85rem;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }
        .details-item .ex { color: var(--text-muted); font-weight: 700; font-size: 0.82rem; letter-spacing: 0.04em; text-transform: uppercase; }
        .details-item .val { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .muted { color: var(--text-muted); }
        .err { color: var(--danger); font-weight: 700; }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2000;
        }
        .modal.open { display: block; }
        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
        }
        .modal-card {
            position: relative;
            max-width: 720px;
            margin: 8vh auto;
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 20px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.55);
            padding: 1.25rem;
            animation: fadeUp 240ms ease-out;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 0.9rem;
            margin-bottom: 0.9rem;
        }
        .modal-title { font-weight: 800; letter-spacing: -0.02em; }
        .modal-close {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.10);
            color: var(--text-main);
            border-radius: 12px;
            padding: 0.55rem 0.75rem;
            font-weight: 800;
            cursor: pointer;
        }
        .modal-body { color: var(--text-muted); }
        .modal-steps { margin-top: 0.75rem; display: grid; gap: 0.6rem; }
        .step {
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.02);
            border-radius: 14px;
            padding: 0.85rem;
            display: flex;
            gap: 0.75rem;
        }
        .step .num {
            width: 28px; height: 28px;
            display: inline-flex;
            align-items: center; justify-content: center;
            border-radius: 10px;
            background: rgba(99,102,241,0.20);
            border: 1px solid rgba(99,102,241,0.35);
            color: white;
            font-weight: 800;
            flex: 0 0 auto;
        }
        .step .txt { color: var(--text-main); font-weight: 600; }
        .modal-footer { margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }

        /* Affiliate CTA section */
        .cta-section { margin-top: 2.5rem; }
        .cta-card {
            background: linear-gradient(135deg, rgba(99,102,241,0.16), rgba(16,185,129,0.08));
            border: 1px solid rgba(129,140,248,0.35);
            border-radius: 24px;
            padding: 2rem;
            overflow: hidden;
            position: relative;
        }
        .cta-card:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(circle at 10% 10%, rgba(129,140,248,0.22), transparent 40%),
                        radial-gradient(circle at 90% 30%, rgba(16,185,129,0.18), transparent 45%);
            filter: blur(10px);
            opacity: 0.8;
            pointer-events: none;
        }
        .cta-inner { position: relative; display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 1.5rem; align-items: center; }
        .cta-inner h3 { font-size: 1.8rem; letter-spacing: -0.02em; }
        .cta-inner p { color: var(--text-muted); margin-top: 0.6rem; }
        .cta-buttons { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; }

        /* News Section */
        .news-section { margin-top: 6rem; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .news-card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; overflow: hidden; transition: transform 0.3s;
        }
        .news-card:hover { transform: translateY(-5px); }
        .news-content { padding: 1.5rem; }
        .news-tag { color: var(--primary-light); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .news-title { font-size: 1.1rem; font-weight: 600; margin: 0.5rem 0 1rem; }
        .news-link { color: var(--text-muted); text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }

        footer { text-align: center; padding: 6rem 2rem; color: var(--text-muted); font-size: 0.9rem; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .nav-links { display: none; }
            nav { padding: 1rem 1rem; }
            .nav-cta { gap: 0.5rem; }
            .btn { padding: 0.7rem 0.95rem; }
            .stats-grid { margin-top: -2rem; }
            .dashboard-card { padding: 1.25rem; }
            th, td { padding: 1rem 0.75rem; }
            .details-grid { grid-template-columns: 1fr; }
            .cta-inner { grid-template-columns: 1fr; }
            .cta-buttons { justify-content: flex-start; }

            /* On mobile: compact table (no horizontal scroll) */
            th:nth-child(2), td:nth-child(2) { display: none; } /* Buy */
            th:nth-child(3), td:nth-child(3) { display: none; } /* Sell */
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="bg-glow"></div>

    <nav>
        <a href="#" class="logo"><i class="fas fa-bolt"></i> CoinNavigator</a>
        <ul class="nav-links">
            <li><a href="#dashboard">Market Spreads</a></li>
            <li><a href="#news">Market News</a></li>
            <li><a href="https://www.binance.com" target="_blank">Binance API</a></li>
            <li><a href="https://www.bybit.com" target="_blank">ByBit API</a></li>
        </ul>
        <div class="nav-cta">
            <a href="#dashboard" class="btn btn-ghost"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="#start" class="btn btn-primary"><i class="fas fa-rocket"></i> Start</a>
        </div>
    </nav>

    <header class="hero">
        <h1>Crypto Spreads Made Simple</h1>
        <p>Compare live prices across top exchanges. Get a clear “buy low / sell high” signal and learn the basics — built for beginners, loved by traders.</p>

        <div class="hero-cta" id="start">
            <a class="btn btn-primary" href="#dashboard"><i class="fas fa-bolt"></i> See Live Opportunities</a>
            <a class="btn btn-ghost" href="#learn"><i class="fas fa-graduation-cap"></i> Learn Arbitrage (Free)</a>
            <a class="btn btn-ghost" href="#bonuses"><i class="fas fa-gift"></i> Claim Bonuses</a>
        </div>

        <div class="trust-row">
            <span class="pill"><i class="fas fa-shield-halved"></i> No login required</span>
            <span class="pill"><i class="fas fa-clock"></i> Updates every 15 minutes</span>
            <span class="pill"><i class="fas fa-list-check"></i> Beginner-friendly guides</span>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <h4>Total Assets</h4>
            <div class="value" id="asset-count">9</div>
        </div>
        <div class="stat-card">
            <h4>Highest Spread</h4>
            <div class="value" id="max-spread">--</div>
        </div>
        <div class="stat-card">
            <h4>Update Frequency</h4>
            <div class="value">15m</div>
        </div>
        <div class="stat-card">
            <h4>API Status</h4>
            <div class="value" style="color: var(--accent)">ONLINE</div>
        </div>
    </div>

    <main class="container">
        <div class="dashboard-card" id="dashboard">
            <div class="table-header">
                <h2>Live Spread Monitor</h2>
                <div class="live-indicator">
                    <div class="dot"></div>
                    LIVE DATA
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Best Buy</th>
                            <th>Best Sell</th>
                            <th>Best Spread</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="spread-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 4rem;">
                                <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="timestamp" style="text-align: right; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.8rem;"></div>
        </div>

        <section class="cta-section" id="bonuses">
            <div class="cta-card">
                <div class="cta-inner">
                    <div>
                        <h3>Start trading smarter — grab exchange bonuses</h3>
                        <p>These buttons are built for affiliate links. You can replace the URLs later with your tracking links.</p>
                    </div>
                    <div class="cta-buttons">
                        <a class="btn btn-primary" href="#" target="_blank"><i class="fas fa-user-plus"></i> Open Binance Account</a>
                        <a class="btn btn-ghost" href="#" target="_blank"><i class="fas fa-user-plus"></i> Open OKX Account</a>
                        <a class="btn btn-ghost" href="#" target="_blank"><i class="fas fa-user-plus"></i> Open KuCoin Account</a>
                        <a class="btn btn-ghost" href="#" target="_blank"><i class="fas fa-gift"></i> Claim Welcome Bonus</a>
                    </div>
                </div>
            </div>
        </section>

        <section class="news-section" id="learn">
            <div class="table-header">
                <h2>Beginner Hub</h2>
            </div>
            <div class="news-grid">
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Getting Started</div>
                        <h3 class="news-title">What is a spread — and why it matters</h3>
                        <a href="#" class="news-link">Read Guide <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Safety</div>
                        <h3 class="news-title">How to avoid common beginner mistakes</h3>
                        <a href="#" class="news-link">Open Checklist <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Tools</div>
                        <h3 class="news-title">Best exchanges for new traders (fees, UX, support)</h3>
                        <a href="#" class="news-link">Compare <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </section>

        <section class="news-section" id="news">
            <div class="table-header">
                <h2>Market Intelligence</h2>
            </div>
            <div class="news-grid">
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Market Analysis</div>
                        <h3 class="news-title">Bitcoin Consolidation: Key Levels to Watch in Q1 2026</h3>
                        <a href="#" class="news-link">Read Analysis <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Arbitrage Tips</div>
                        <h3 class="news-title">How to minimize slippage during high-spread events</h3>
                        <a href="#" class="news-link">View Guide <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
                <div class="news-card">
                    <div class="news-content">
                        <div class="news-tag">Ecosystem</div>
                        <h3 class="news-title">ByBit increases liquidity for SOL/USDT trading pairs</h3>
                        <a href="#" class="news-link">Read More <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p>&copy; 2025 CoinNavigator | Professional Grade Crypto Tools</p>
        <p style="margin-top: 1rem; opacity: 0.5;">Trading cryptocurrency involves risk. Our data is for informational purposes only.</p>
    </footer>

    <!-- How-To modal (beginner-friendly) -->
    <div class="modal" id="how-modal" aria-hidden="true">
        <div class="modal-backdrop" data-close="how"></div>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="how-title">
            <div class="modal-header">
                <div>
                    <div class="muted" style="font-weight: 800; letter-spacing: 0.06em; font-size: 0.75rem; text-transform: uppercase;">Beginner Mode</div>
                    <div class="modal-title" id="how-title">How to execute this spread</div>
                </div>
                <button class="modal-close" type="button" data-close="how">Close</button>
            </div>
            <div class="modal-body">
                <div class="muted" id="how-summary">—</div>
                <div class="modal-steps">
                    <div class="step">
                        <div class="num">1</div>
                        <div>
                            <div class="txt">Open accounts on both exchanges</div>
                            <div class="muted">Use the “Open Account” buttons (affiliate links can be added later).</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="num">2</div>
                        <div>
                            <div class="txt">Buy on the cheaper exchange</div>
                            <div class="muted">Place a market/limit order and confirm your filled price.</div>
                        </div>
                    </div>
                    <div class="step">
                        <div class="num">3</div>
                        <div>
                            <div class="txt">Sell on the more expensive exchange</div>
                            <div class="muted">Keep an eye on fees, slippage, and transfer time.</div>
                        </div>
                    </div>
                </div>
                <div class="muted" style="margin-top: 0.9rem; font-size: 0.85rem;">
                    Disclaimer: spreads can disappear fast. Always do your own research.
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary" href="#bonuses"><i class="fas fa-gift"></i> Claim Bonuses</a>
                    <a class="btn btn-ghost" href="#learn"><i class="fas fa-graduation-cap"></i> Read Beginner Guides</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function fetchJsonWithFallback() {
            const origins = [
                window.location.origin,
                'https://www.coinnavigator.net',
            ];

            const candidates = [];
            for (const origin of origins) {
                candidates.push(new URL('/spread_data.json', origin).toString());
                candidates.push(new URL('/data/spread_data.json', origin).toString());
            }

            let lastError = null;
            for (const baseUrl of candidates) {
                const url = baseUrl + '?v=' + Date.now();
                try {
                    const res = await fetch(url, { cache: 'no-store' });
                    if (!res.ok) {
                        lastError = new Error(`HTTP ${res.status} for ${baseUrl}`);
                        continue;
                    }
                    return await res.json();
                } catch (e) {
                    lastError = e;
                }
            }
            throw lastError ?? new Error('Failed to fetch spread data');
        }

        async function updateDashboard() {
            try {
                console.log('Fetching data...');
                const data = await fetchJsonWithFallback();
                console.log('Data received:', data);

                const tbody = document.getElementById('spread-body');
                const timestampDiv = document.getElementById('timestamp');
                const maxSpreadDiv = document.getElementById('max-spread');
                const assetCountDiv = document.getElementById('asset-count');
                
                tbody.innerHTML = '';
                let highestSpread = 0;
                let count = 0;

                const exchangeUrls = {
                    Binance: 'https://www.binance.com',
                    OKX: 'https://www.okx.com',
                    KuCoin: 'https://www.kucoin.com',
                    Gate: 'https://www.gate.io',
                    MEXC: 'https://www.mexc.com',
                    Bybit: 'https://www.bybit.com',
                };

                // Affiliate link placeholders — replace values later with your tracking links.
                const AFFILIATE = {
                    signup: {
                        Binance: '#',
                        OKX: '#',
                        KuCoin: '#',
                        Gate: '#',
                        MEXC: '#',
                        Bybit: '#',
                    },
                    bonus: '#bonuses',
                    guide: '#learn',
                };

                function openHowModal(payload) {
                    const modal = document.getElementById('how-modal');
                    const summary = document.getElementById('how-summary');
                    if (!modal || !summary) return;
                    summary.textContent = payload;
                    modal.classList.add('open');
                    modal.setAttribute('aria-hidden', 'false');
                }

                function closeHowModal() {
                    const modal = document.getElementById('how-modal');
                    if (!modal) return;
                    modal.classList.remove('open');
                    modal.setAttribute('aria-hidden', 'true');
                }

                document.querySelectorAll('[data-close="how"]').forEach((el) => {
                    el.addEventListener('click', closeHowModal);
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeHowModal();
                });

                for (const [symbol, info] of Object.entries(data.symbols)) {
                    count++;
                    // Backwards-compatible fallback (older JSON only had binance_price/bybit_price).
                    const prices = (info.prices && Object.keys(info.prices).length)
                        ? info.prices
                        : {
                            Binance: info.binance_price,
                            Bybit: info.bybit_price,
                        };

                    const hasBest = info.best_buy && info.best_sell;
                    const hasSpread = typeof info.spread_percent === 'number' && (hasBest || info.higher_exchange);

                    let displaySpreadText = 'N/A';
                    let spreadDetails = '';
                    if (hasSpread) {
                        const displaySpread = info.spread_percent * 100;
                        displaySpreadText = displaySpread.toFixed(4) + '%';
                        if (displaySpread > highestSpread) highestSpread = displaySpread;
                        if (info.best_buy && info.best_sell) {
                            spreadDetails = `Buy ${info.best_buy.exchange} / Sell ${info.best_sell.exchange}`;
                        } else if (info.higher_exchange) {
                            spreadDetails = `Higher: ${info.higher_exchange}`;
                        }
                    }

                    const fmt = (v) => (typeof v === 'number')
                        ? `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 8 })}`
                        : 'N/A';

                    const buyText = hasBest ? `${info.best_buy.exchange} • ${fmt(info.best_buy.price)}` : 'N/A';
                    const sellText = hasBest ? `${info.best_sell.exchange} • ${fmt(info.best_sell.price)}` : 'N/A';

                    const buyUrl = hasBest ? (exchangeUrls[info.best_buy.exchange] || '#') : '#';
                    const sellUrl = hasBest ? (exchangeUrls[info.best_sell.exchange] || '#') : '#';
                    const buySignupUrl = hasBest ? (AFFILIATE.signup[info.best_buy.exchange] || '#') : '#';
                    const sellSignupUrl = hasBest ? (AFFILIATE.signup[info.best_sell.exchange] || '#') : '#';

                    const actionHtml = hasBest
                        ? `<div class="row-actions">
                             <a class="btn-mini btn-mini-primary" href="${buyUrl}" target="_blank" title="Buy on ${info.best_buy.exchange}"><i class="fas fa-cart-shopping"></i> Buy</a>
                             <a class="btn-mini" href="${sellUrl}" target="_blank" title="Sell on ${info.best_sell.exchange}"><i class="fas fa-right-left"></i> Sell</a>
                             <a class="btn-mini" href="${buySignupUrl}" target="_blank" title="Open account on ${info.best_buy.exchange}" data-aff="signup-buy"><i class="fas fa-user-plus"></i> Open ${info.best_buy.exchange}</a>
                             <a class="btn-mini" href="${sellSignupUrl}" target="_blank" title="Open account on ${info.best_sell.exchange}" data-aff="signup-sell"><i class="fas fa-user-plus"></i> Open ${info.best_sell.exchange}</a>
                             <a class="btn-mini" href="${AFFILIATE.bonus}" title="Bonuses" data-aff="bonus"><i class="fas fa-gift"></i> Bonus</a>
                             <a class="btn-mini" href="${AFFILIATE.guide}" title="Beginner guides" data-aff="guide"><i class="fas fa-graduation-cap"></i> Guide</a>
                             <button class="btn-mini" type="button" data-toggle="details"><i class="fas fa-circle-info"></i> Prices</button>
                             <button class="btn-mini" type="button" data-open="how"><i class="fas fa-wand-magic-sparkles"></i> How</button>
                           </div>`
                        : `<span class="muted">Partial data</span>`;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="symbol-box">
                                <i class="fas fa-coins" style="color: #f7931a"></i>
                                <span class="name">${symbol.replace('USDT', '')}</span>
                            </div>
                        </td>
                        <td class="price-val">${buyText}</td>
                        <td class="price-val">${sellText}</td>
                        <td><span class="spread-val" title="${spreadDetails}">${displaySpreadText}</span></td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(row);

                    // Details row (all exchange prices + any errors)
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'details-row';
                    detailsRow.style.display = 'none';
                    const errMap = (data.errors && data.errors[symbol]) ? data.errors[symbol] : null;
                    const exchangeKeys = Object.keys(prices);
                    const detailsItems = exchangeKeys.map((ex) => {
                        const v = prices[ex];
                        const err = errMap && errMap[ex] && typeof v !== 'number' ? errMap[ex] : null;
                        const right = (typeof v === 'number') ? fmt(v) : (err ? `<span class="err">${err}</span>` : 'N/A');
                        return `<div class="details-item"><span class="ex">${ex}</span><span class="val">${right}</span></div>`;
                    }).join('');
                    detailsRow.innerHTML = `<td colspan="5">
                        <div class="details">
                            <div class="muted" style="margin-bottom: 0.75rem;">All observed prices (some exchanges may be temporarily blocked).</div>
                            <div class="details-grid">${detailsItems}</div>
                        </div>
                    </td>`;
                    tbody.appendChild(detailsRow);

                    const toggleBtn = row.querySelector('button[data-toggle="details"]');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => {
                            detailsRow.style.display = (detailsRow.style.display === 'none') ? '' : 'none';
                        });
                    }

                    const howBtn = row.querySelector('button[data-open="how"]');
                    if (howBtn && hasBest) {
                        howBtn.addEventListener('click', () => {
                            const asset = symbol.replace('USDT', '');
                            const msg = `${asset}: Buy on ${info.best_buy.exchange} at ${fmt(info.best_buy.price)} • Sell on ${info.best_sell.exchange} at ${fmt(info.best_sell.price)} • Spread ${displaySpreadText}`;
                            openHowModal(msg);
                        });
                    }
                }

                assetCountDiv.innerText = count;
                maxSpreadDiv.innerText = highestSpread > 0 ? (highestSpread.toFixed(3) + '%') : '--';
                
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    timestampDiv.innerHTML = `<i class="far fa-clock"></i> Last updated: ${date.toLocaleString()}`;
                }
                
            } catch (error) {
                console.error('Detailed Error:', error);
                document.getElementById('spread-body').innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--danger); padding: 4rem;">
                    <div style="margin-bottom: 10px;">Sync Error: ${error.message}</div>
                    <div style="font-size: 0.7rem; opacity: 0.7;">Make sure data/spread_data.json exists on GitHub</div>
                </td></tr>`;
            }
        }

        updateDashboard();
        setInterval(updateDashboard, 60000);
    </script>
</body>
</html>
